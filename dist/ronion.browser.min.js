/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
 0BSD
*/
(function(u){if("object"===typeof exports&&"undefined"!==typeof module)module.exports=u();else if("function"===typeof define&&define.a)define([],u);else{var e;"undefined"!==typeof window?e=window:"undefined"!==typeof global?e=global:"undefined"!==typeof self?e=self:e=this;e.V=u()}})(function(){return function q(e,m,n){function g(f,h){if(!m[f]){if(!e[f]){var p="function"==typeof require&&require;if(!h&&p)return p(f,!0);if(k)return k(f,!0);h=Error("Cannot find module '"+f+"'");throw h.code="MODULE_NOT_FOUND",
h;}h=m[f]={exports:{}};e[f][0].call(h.exports,function(a){var b=e[f][1][a];return g(b?b:a)},h,h.exports,q,e,m,n)}return m[f].exports}for(var k="function"==typeof require&&require,f=0;f<n.length;f++)g(n[f]);return g}({1:[function(e,m,n){(function(){function e(){if(!(this instanceof e))return new e;this.v={}}e.prototype={on:function(g,e){var f;g&&e&&((f=this.v)[g]||(f[g]=[])).push(e);return this},off:function(g,e){(g=this.v[g])&&g.splice(g.indexOf(e),e?1:g.length);return this},once:function(e,k){var f=
this;if(e&&k){var g=function(){if(!g.a)return g.a=!0,f.off(e,g),k.apply(null,arguments)};this.on(e,g)}return this},fire:function(e,k){var f=Promise.resolve();var g=arguments;(this.v[e]||[]).forEach(function(e){f=f.then(function(){var f=e.call.apply(e,g);return!1===f?Promise.reject():f})});f["catch"](function(f){f instanceof Error&&console.error(f)});return f}};"object"===typeof n?m.exports=e:this.async_eventer=e}).call(this)},{}],2:[function(e,m){(function(){function n(a){var b=a%256;return Uint8Array.of((a-
b)/256,b)}function q(a){var b=a.subarray(1,3);return[a[0],a.slice(3,3+(256*b[0]+b[1]))]}function g(a,b,c){a=new Uint8Array(a);a.set(b);a.set(c,2);return a}function k(a,b,c){c=new Uint8Array(3+c);c.set([a]);c.set(n(b.length),1);c.set(b,3);return c}function f(a,b){return a.join(",")+b.join(",")}function p(a){if(a instanceof Error)return console.error(a)}function h(a,b,c,d){null==d&&(d=10);if(!(this instanceof h))return new h(a,b,c,d);v.call(this);this.i=a;this.u=b;this.s=c;this.N=d;this.b=new Map;this.f=
new Set;this.c=new Map;this.j=new Map;this.l=new Map;this.a=new Map}var v=e("async-eventer");m.exports=h;h.prototype={process_packet:function(a,b){if(b.length===this.i){var c=[b.subarray(0,2),b.subarray(2)];b=c[0];c=c[1];this.fire("activity",a,b);var d=f(a,b);this.b.has(d)||this.f.has(d)||this.a.has(d)?this.O(a,b,c):this.P(a,b,c)}},confirm_outgoing_segment_established:function(a,b){this.b.set(f(a,b),[a]);this.g(a,b)},confirm_incoming_segment_established:function(a,b){this.f.add(f(a,b));this.g(a,b)},
confirm_extended_path:function(a,b){a=f(a,b);b=this.l.get(a);this.b.get(a).push(b);this.l["delete"](a)},create_request:function(a,b){if(b.length>this.m())throw new RangeError("Too much command data");var c=this.M(a);b=this.D(c,0,b);this.h(a,c,b);this.o(a,c);return c},create_response:function(a,b,c){if(c.length>this.m())throw new RangeError("Too much command data");c=this.D(b,1,c);this.h(a,b,c)},extend_request:function(a,b,c,d){var l,r=this;var e=f(a,b);if(!this.b.has(e))throw new ReferenceError("There is no such segment established");
if(d.length>this.m()-this.u)throw new RangeError("Too much command data");var t=this.b.get(e).slice(-1)[0];var g=l=new Uint8Array(c.length+d.length);g.set(c);g.set(d,c.length);this.A(a,b,t,2,l).then(function(d){r.h(a,b,d);r.l.set(e,c)})["catch"](p)},C:function(a,b,c){var d=this;this.A(a,b,a,3,c).then(function(c){d.h(a,b,c)})["catch"](p)},destroy:function(a,b){var c=f(a,b);this.b["delete"](c);this.f["delete"](c);this.l["delete"](c);this.g(a,b);if(this.a.has(c)){var d=this.a.get(c);c=d[0];d=d[1];this.B(a,
b);this.destroy(c,d)}else this.B(a,b)},data:function(a,b,c,d,l){var e=this;var g=f(a,b);if(!this.b.has(g)&&!this.f.has(g))throw new ReferenceError("There is no such segment established");if(l.length>this.m())throw new RangeError("Too much command data");this.A(a,b,c,d+10,l).then(function(c){e.h(a,b,c)})["catch"](p)},get_max_command_data_length:function(){return this.i-2-1-2-this.s},h:function(a,b,c){this.fire("activity",a,b);return this.fire("send",a,c)},P:function(a,b,c){var d=f(a,b);c=q(c);var l=
c[0];c=c[1];switch(l){case 0:this.o(a,b);this.fire("create_request",a,b,c);break;case 1:this.c.has(d)&&(d=this.c.get(d),d.I?(a=d.I,this.C(a.S,a.T,c)):this.fire("create_response",a,b,c))}},O:function(a,b,c){var d=this;this.R(a,b,c).then(function(c){var l=f(a,b);!d.f.has(l)&&d.a.has(l)?d.w(l,c):d.K(a,b,c).then(function(c){var f=q(c.plaintext);var e=f[0];f=f[1];switch(e){case 2:try{var g=f.subarray(0,d.u);var r=f.subarray(d.u);var h=d.U(g,r);var w={S:a,T:b};var k=[g,h];d.o(a,b,{H:k});d.o(g,h,{I:w})}catch(x){c=
x;if(!(c instanceof RangeError))throw c;d.C(a,b,new Uint8Array(0))}break;case 3:d.l.has(l)&&d.fire("extend_response",a,b,f);break;default:10>e||d.fire("data",a,b,c.target_address,e-10,f)}},function(){if(d.a.has(l))d.w(l,c);else if(d.c.has(l)){var f=d.c.get(l);if(f.H){var e=f.H;f=e[0];e=e[1];d.g(a,b);d.g(f,e);d.J(a,b,f,e)&&d.w(l,c)}}})})["catch"](p)},w:function(a,b){var c=this.a.get(a);a=c[0];c=c[1];b=g(this.i,c,b);this.h(a,c,b)},M:function(a){var b;var c=0;for(b=Math.pow(2,16);c<b;++c){var d=c;d=
n(d);var l=f(a,d);if(!this.b.has(l)&&!this.c.has(l)&&!this.f.has(l))return d}throw new RangeError("Out of possible segment IDs");},D:function(a,b,c){b=k(b,c,this.m());return g(this.i,a,b)},A:function(a,b,c,d,f){var e=this;d=k(d,f,this.m());return this.L(a,b,c,d).then(function(a){return g(e.i,b,a)})},J:function(a,b,c,d){var e=f(a,b);var g=f(c,d);if(this.a.has(e)||this.a.has(g))return!1;this.a.set(e,[c,d]);this.a.set(g,[a,b]);return!0},B:function(a,b){a=f(a,b);if(this.a.has(a)){var c=this.a.get(a);
b=c[0];c=c[1];b=f(b,c);this.a["delete"](a);this.a["delete"](b)}},o:function(a,b,c){null==c&&(c={});this.g(a,b);var d=f(a,b);var e=a.join("");this.c.set(d,c);this.j.has(e)||this.j.set(e,[]);c=this.j.get(e);c.push(b);c.length>this.N&&(b=c.shift(),this.g(a,b))},g:function(a,b){var c;var d=f(a,b);if(this.c.has(d)){this.c["delete"](d);a=a.join("");b=b.join("");d=this.j.get(a);var e=0;for(c=d.length;e<c;++e){var g=e;var h=d[e];if(h.join("")===b){d.splice(g,1);return}}if(!d.length)this.j["delete"](a)}},
L:function(a,b,c,d){var e,g=this;var h=f(a,b);var t={address:a,segment_id:b,target_address:c,plaintext:d,ciphertext:null};var k=this.fire("encrypt",t).then(function(){var a=t.ciphertext;if(!(a instanceof Uint8Array)||a.length!==d.length+g.s)throw"Encryption failed";return a});this.b.has(h)?e=this.b.get(h):e=[c];e=function(a){var b,c;var d=[];var f=0;for(c=(b=e).length;f<c;++f){var g=b[f];d.push(g);if(a===g.join(","))break}return d}.call(this,c.join(","));e.reverse().forEach(function(c){return k=k.then(function(d){return g.G(a,
b,c,d)})});return k},K:function(a,b,c){var d,e=this;var g=f(a,b);this.b.has(g)?d=this.b.get(g):d=[a];var h=Promise.reject();var k={address:a,segment_id:b,target_address:null,ciphertext:c,plaintext:null};d.forEach(function(d,f){h=h["catch"](function(){k.target_address=d;return 0<f?e.F(a,b,d,k.ciphertext).then(function(a){k.ciphertext=a;return e.fire("decrypt",k)}):e.fire("decrypt",k)}).then(function(){var a=k.plaintext;if(!(a instanceof Uint8Array)||a.length!==c.length-e.s)throw"Decryption failed";
return k})});return h},R:function(a,b,c){var d=f(a,b);if(this.b.has(d)||this.f.has(d))return this.F(a,b,a,c);a=this.a.get(d);b=a[0];return this.G(b,a[1],b,c)},G:function(a,b,c,d){var e={address:a,segment_id:b,target_address:c,unwrapped:d,wrapped:null};return this.fire("wrap",e).then(function(){var a=e.wrapped;if(!(a instanceof Uint8Array)||a.length!==d.length)throw"Wrapping failed";return a})},F:function(a,b,c,d){var e={address:a,segment_id:b,target_address:c,wrapped:d,unwrapped:null};return this.fire("unwrap",
e).then(function(){var a=e.unwrapped;if(!(a instanceof Uint8Array)||a.length!==d.length)throw"Unwrapping failed";return a})}};h.prototype=Object.assign(Object.create(v.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{enumerable:!1,value:h})}).call(this)},{"async-eventer":1}]},{},[2])(2)});