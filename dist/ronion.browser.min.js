/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(t){if("object"===typeof exports&&"undefined"!==typeof module)module.exports=t();else if("function"===typeof define&&define.a)define([],t);else{var f;"undefined"!==typeof window?f=window:"undefined"!==typeof global?f=global:"undefined"!==typeof self?f=self:f=this;f.da=t()}})(function(){return function q(f,m,n){function h(e,k){if(!m[e]){if(!f[e]){var a="function"==typeof require&&require;if(!k&&a)return a(e,!0);if(l)return l(e,!0);k=Error("Cannot find module '"+e+"'");throw k.code="MODULE_NOT_FOUND",
k;}k=m[e]={exports:{}};f[e][0].call(k.exports,function(a){var b=f[e][1][a];return h(b?b:a)},k,k.exports,q,f,m,n)}return m[e].exports}for(var l="function"==typeof require&&require,e=0;e<n.length;e++)h(n[e]);return h}({1:[function(f,m,n){(function(){function f(){if(!(this instanceof f))return new f;this.I={}}f.prototype={on:function(h,f){var e;h&&f&&((e=this.I)[h]||(e[h]=[])).push(f);return this},off:function(h,f){(h=this.I[h])&&h.splice(h.indexOf(f),f?1:h.length);return this},once:function(f,l){var e=
this;if(f&&l){var h=function(){if(!h.a)return h.a=!0,e.off(f,h),l.apply(null,arguments)};this.on(f,h)}return this},fire:function(f,l){var e=Promise.resolve();var h=arguments;(this.I[f]||[]).forEach(function(f){e=e.then(function(){var a=f.call.apply(f,h);return!1===a?Promise.reject():a})});e["catch"](function(e){e instanceof Error&&console.error(e)});return e}};"object"===typeof n?m.exports=f:this.async_eventer=f}).call(this)},{}],2:[function(f,m){(function(){function n(a){var b=a%256;return Uint8Array.of((a-
b)/256,b)}function q(a){var b=a.subarray(1,3);return[a[0],a.slice(3,3+(256*b[0]+b[1]))]}function h(a,b,c,d){a=new Uint8Array(a);a.set([b]);a.set(c,1);a.set(d,3);return a}function l(a,b,c){c=new Uint8Array(3+c);c.set([a]);c.set(n(b.length),1);c.set(b,3);return c}function e(a,b){return a.join(",")+b.join(",")}function p(a,b,c,d,g){null==g&&(g=10);if(!(this instanceof p))return new p(a,b,c,d,g);k.call(this);this.C=a;this.m=b;this.H=c;this.F=d;this.X=g;this.a=new Map;this.g=new Set;this.h=new Map;this.w=
new Map;this.A=new Map;this.c=new Map}var k=f("async-eventer");m.exports=p;p.prototype={process_packet:function(a,b){if(b.length===this.m){var c=[b[0],b.subarray(1,3),b.subarray(3)];var d=c[0];b=c[1];c=c[2];d===this.C&&(d=e(a,b),this.a.has(d)||this.g.has(d)||this.c.has(d)?this.Y(a,b,c):this.Z(a,b,c))}},confirm_outgoing_segment_established:function(a,b){this.a.set(e(a,b),[a]);this.j(a,b)},confirm_incoming_segment_established:function(a,b){this.g.add(e(a,b));this.j(a,b)},confirm_extended_path:function(a,
b){a=e(a,b);b=this.A.get(a);this.a.get(a).push(b);this.A["delete"](a)},create_request:function(a,b){if(b.length>this.o())throw new RangeError("Too much command data");var c=this.W(a);b=this.L(c,1,b);this.fire("send",{b:a,l:b});this.v(a,c);return c},create_response:function(a,b,c){if(c.length>this.o())throw new RangeError("Too much command data");b=this.L(b,2,c);this.fire("send",{b:a,l:b})},extend_request:function(a,b,c,d){var g,r=this;var f=e(a,b);if(!this.a.has(f))throw new ReferenceError("There is no such segment established");
if(d.length>this.o()-this.H)throw new RangeError("Too much command data");var v=this.a.get(f).slice(-1)[0];var h=g=new Uint8Array(c.length+d.length);h.set(c);h.set(d,c.length);this.u(a,b,v,3,g).then(function(b){r.fire("send",{b:a,l:b});r.A.set(f,c)})},K:function(a,b,c){var d=this;this.u(a,b,a,4,c).then(function(b){d.fire("send",{b:a,l:b})})},destroy:function(a,b){var c=this;var d=e(a,b);if(!this.a.has(d))throw new ReferenceError("There is no such segment established");var g=this.a.get(d);this.u(a,
b,g[g.length-1],5,new Uint8Array(0)).then(function(b){g.pop();if(!g.length)c.a["delete"](d);c.fire("send",{b:a,l:b})})},data:function(a,b,c,d){var g=this;var f=e(a,b);if(!this.a.has(f)&&!this.g.has(f))throw new ReferenceError("There is no such segment established");if(d.length>this.o())throw new RangeError("Too much command data");this.u(a,b,c,6,d).then(function(b){g.fire("send",{b:a,l:b})})},get_max_command_data_length:function(){return this.m-1-2-1-2-this.F},Z:function(a,b,c){var d=e(a,b);c=q(c);
var g=c[0];c=c[1];switch(g){case 1:this.v(a,b);this.fire("create_request",{b:a,f:b,G:c});break;case 2:this.h.has(d)&&(d=this.h.get(d),d.P?(a=d.P,this.K(a.b,a.f,c)):this.fire("create_response",{b:a,f:b,G:c}))}},Y:function(a,b,c){var d=this;this.$(a,b,c).then(function(c){var g=e(a,b);!d.g.has(g)&&d.c.has(g)?d.D(g,c):d.U(a,b,c).then(function(c){var e=q(c.B);var f=e[0];e=e[1];switch(f){case 3:try{var h=e.subarray(0,d.H);var r=e.subarray(d.H);var u=d.ca(h,r);var k={b:a,f:b};var l={aa:h,ba:u};d.v(a,b,{O:l});
d.v(h,u,{P:k})}catch(w){c=w;if(!(c instanceof RangeError))throw c;d.K(a,b,new Uint8Array(0))}break;case 4:d.A.has(g)&&d.fire("extend_response",{b:a,f:b,G:e});break;case 5:d.g.has(g)&&(d.g["delete"](g),d.J(a,b),d.fire("destroy",{b:a,f:b}));break;case 6:d.fire("data",{b:a,f:b,i:c.i,G:e})}},function(){if(d.c.has(g))d.D(g,c);else if(d.h.has(g)){var e=d.h.get(g);if(e.O){var f=e.O;e=f.aa;f=f.ba;d.j(a,b);d.j(e,f);d.T(a,b,e,f);d.D(g,c)}}})})},D:function(a,b){var c=this.c.get(a);a=c[0];b=h(this.m,this.C,c[1],
b);this.fire("send",{b:a,l:b})},W:function(a){var b;var c=0;for(b=Math.pow(2,16);c<b;++c){var d=c;d=n(d);var g=e(a,d);if(!this.a.has(g)&&!this.h.has(g)&&!this.g.has(g))return d}throw new RangeError("Out of possible segment IDs");},L:function(a,b,c){b=l(b,c,this.o());return h(this.m,this.C,a,b)},u:function(a,b,c,d,e){var g=this;d=l(d,e,this.o());return this.V(a,b,c,d).then(function(a){return h(g.m,g.C,b,a)})},T:function(a,b,c,d){this.J(a,b);this.J(c,d);var g=e(a,b);var f=e(c,d);this.c.set(g,[c,d]);
this.c.set(f,[a,b])},J:function(a,b){a=e(a,b);if(this.c.has(a)){var c=this.c.get(a);b=c[0];c=c[1];b=e(b,c);this.c["delete"](a);this.c["delete"](b)}},v:function(a,b,c){!c&&(c={});this.j(a,b);var d=e(a,b);var g=a.join("");this.h.set(d,c);this.w.has(g)||this.w.set(g,[]);c=this.w.get(g);c.push(b);c.length>this.X&&(b=c.shift(),this.j(a,b))},j:function(a,b){var c;var d=e(a,b);if(this.h.has(d))for(this.h["delete"](d),a=a.join(""),b=b.join(""),a=this.w.get(a),d=0,c=a.length;d<c;++d){var g=d;var f=a[d];if(f.join("")===
b){a.splice(g,1);break}}},V:function(a,b,c,d){var g,f=this;var h=e(a,b);var k={b:a,f:b,i:c,B:d,s:null};var l=this.fire("encrypt",k).then(function(){var a=k.s;if(!(a instanceof Uint8Array)||a.length!==d.length+f.F)throw Error("Encryption failed");return a});this.a.has(h)?g=this.a.get(h):g=[c];var m=c.join("");g.every(function(c){l=l.then(function(d){return f.N(a,b,c,d)});return m!==c.join("")});l["catch"](function(){});return l},U:function(a,b,c){var d,g=this;var f=e(a,b);this.a.has(f)?d=this.a.get(f):
d=[a];var h=Promise.reject();var k={b:a,f:b,ea:null,s:c,B:null};d.forEach(function(d,e){h=h["catch"](function(){k.i=d;return 0<e?g.M(a,b,d,k.s).then(function(a){k.s=a;return g.fire("decrypt",k)}):g.fire("decrypt",k)}).then(function(){var a=k.B;if(!(a instanceof Uint8Array)||a.length!==c.length-g.F)throw Error("Decryption failed");return{B:a,i:k.i}})});h["catch"](function(){});return h},$:function(a,b,c){var d=e(a,b);if(this.a.has(d)||this.g.has(d))return this.M(a,b,a,c);a=this.c.get(d);b=a[0];return this.N(b,
a[1],b,c)},N:function(a,b,c,d){var e={b:a,f:b,i:c,R:d,S:null};a=this.fire("wrap",e).then(function(){var a=e.S;if(!(a instanceof Uint8Array)||a.length!==d.length)throw Error("Re-wrapping failed");return a});a["catch"](function(){});return a},M:function(a,b,c,d){var e={b:a,f:b,i:c,S:d,R:null};a=this.fire("unwrap",e).then(function(){var a=e.R;if(!(a instanceof Uint8Array)||a.length!==d.length)throw Error("Re-wrapping failed");return a});a["catch"](function(){});return a}};p.prototype=Object.assign(Object.create(k.prototype),
p.prototype);Object.defineProperty(p.prototype,"constructor",{enumerable:!1,value:p})}).call(this)},{"async-eventer":1}]},{},[2])(2)});